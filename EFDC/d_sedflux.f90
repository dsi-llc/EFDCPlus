! ----------------------------------------------------------------------
!   This file is a part of EFDC+
!   Website:  https://eemodelingsystem.com/
!   Repository: https://github.com/dsi-llc/EFDC_Plus.git
! ----------------------------------------------------------------------
! Copyright 2021-2022 DSI, LLC
! Distributed under the GNU GPLv2 License.
! ----------------------------------------------------------------------
SUBROUTINE SEDFLUXNEW(L, SMSOD1, SMCH4S, SMK1CH4, SMO2JC, RSMSS,                         &
                      SK1NH4SM, A1NH4SM, A2NH4SM,           A22NH4SM, B1NH4SM, B2NH4SM,  &
                      SK1NO3SM, A1NO3SM, A2NO3SM, RK2NO3SM, A22NO3SM, B1NO3SM, B2NO3SM,  &
                      SK1H2SSM, A1H2SSM, A2H2SSM,           A22H2SSM, B1H2SSM, B2H2SSM,  &
                      RSM1H2S, RSM1NH4, RSM1NO3, RSM2H2S, RSM2NH4, RSM2NO3,              &
                      CSODSM, RNSODSM, RJNITSM, RJDENSM, AQJH2SSM, AQJCH4SM, GJCH4SM, SEDFLUX)

  ! SOLVE MASS-BALANCE EQ'S FOR NH4, NO3 & H2S/CH4 AND THEIR FLUXES.
  
  USE GLOBAL
  IMPLICIT NONE

  INTEGER, INTENT(IN)  :: L
  REAL, INTENT(IN)     :: SMSOD1, SMCH4S, SMK1CH4, SMO2JC
  REAL, INTENT(IN)     :: SK1NH4SM, A1NH4SM, A2NH4SM,           A22NH4SM, B1NH4SM, B2NH4SM  
  REAL, INTENT(IN)     :: SK1NO3SM, A1NO3SM, A2NO3SM, RK2NO3SM, A22NO3SM, B1NO3SM, B2NO3SM
  REAL, INTENT(IN)     :: SK1H2SSM, A1H2SSM, A2H2SSM,           A22H2SSM, B1H2SSM, B2H2SSM
  REAL, INTENT(INOUT)  :: RSM1H2S, RSM1NH4, RSM1NO3, RSM2H2S, RSM2NH4, RSM2NO3
  REAL, INTENT(INOUT)  :: CSODSM, RNSODSM, RJNITSM, RJDENSM, AQJH2SSM, AQJCH4SM, GJCH4SM, SEDFLUX, RSMSS

  REAL :: RRNH4,RRNO3,RRH2S,SMTT1,SMTT2,SMTT3,SMSECH
  REAL :: A11NH4,B11NH4,B22NH4
  REAL :: A11NO3,B11NO3,B22NO3
  REAL :: A11H2S,B11H2S,B22H2S
  REAL :: CSODMSM, SMJ2H2S, SMSOD


  RSMSS = SMSOD1 / (XSMO20(L)+ 1.E-18)

  ! *** NH4
  RRNH4 = SK1NH4SM/(RSMSS+ 1.E-18)
  A11NH4 = RSMSS*SMFD1NH4 + A1NH4SM + RRNH4
  B11NH4 = RSMSS*B1NH4SM
  B22NH4 = B2NH4SM

  CALL SOLVSMBE(RSM1NH4,RSM2NH4,A11NH4,A22NH4SM,A1NH4SM,A2NH4SM,B11NH4,B22NH4)

  RJNITSM = RRNH4 * RSM1NH4
  
  ! *** NO3
  RRNO3 = SK1NO3SM/(RSMSS+ 1.E-18)
  A11NO3 = RSMSS + A1NO3SM + RRNO3
  B11NO3 = RJNITSM + RSMSS*B1NO3SM
  B22NO3 = B2NO3SM

  CALL SOLVSMBE(RSM1NO3,RSM2NO3,A11NO3,A22NO3SM,A1NO3SM,A2NO3SM,B11NO3,B22NO3)

  RJDENSM = RRNO3*RSM1NO3 + RK2NO3SM*RSM2NO3

  ! *** H2S/CH4: SMCH4S=2*SMKL12*SMCH4S

  ! *** SMO2JC          - Max CH4 production
  ! *** SMO2NO3*RJDENSM - Nitrification
  ! *** SMJ2H2S         - Flux of methane in oxygen equivalent units (M/L2/T)
  SMJ2H2S = MAX(SMO2JC - SMO2NO3*RJDENSM, 0.0)
  IF( SAL(L,KSZ(L)) > SMCSHSCH )THEN
    RRH2S = SK1H2SSM/(RSMSS+ 1.E-18)
    SMTT1 = RSMSS*SMFD1H2S
    A11H2S = SMTT1 + A1H2SSM + RRH2S
    B11H2S = B1H2SSM
    B22H2S = B2H2SSM + SMJ2H2S

    CALL SOLVSMBE(RSM1H2S,RSM2H2S,A11H2S,A22H2SSM,A1H2SSM,A2H2SSM,B11H2S,B22H2S)

    AQJH2SSM = SMTT1*RSM1H2S
    CSODSM = RRH2S*RSM1H2S
    AQJCH4SM = 0.0
    GJCH4SM = 0.0
  ELSE
    CSODMSM = MIN( SQRT(SMCH4S*SMJ2H2S), SMJ2H2S )
    SMTT2 = SMK1CH4 / (RSMSS+ 1.E-18)
    IF( SMTT2 < 80.0 )THEN
      SMTT3 = EXP(SMTT2)
      SMSECH = 2.0 / (SMTT3 + 1.0/SMTT3)
    ELSE
      SMSECH = 0.0
    ENDIF
    AQJCH4SM = CSODMSM*SMSECH
    CSODSM = CSODMSM - AQJCH4SM
    GJCH4SM = SMJ2H2S - CSODMSM
    AQJH2SSM = 0.0
  ENDIF
  RNSODSM = SMO2NH4*RJNITSM
  SMSOD = CSODSM + RNSODSM
  SEDFLUX = SMSOD - SMSOD1

  RETURN
END

